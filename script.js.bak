const SUPABASE_URL = 'https://nnssmlllzdnubikllrdg.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im5uc3NtbGxsemRudWJpa2xscmRnIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU2ODA3OTcsImV4cCI6MjA3MTI1Njc5N30.ayPyC8nuEiBwtA4ncoPtGSZFioWnvmB607NtySzdFuw';

const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

class ReignsGame {
    constructor() {
        this.stats = {
            mental: 50,
            finance: 50,
            ability: 30,
            confidence: 50,
            health: 50
        };
        
        this.age = 25;
        this.week = 1;
        this.totalWeeks = 1;
        this.gameOver = false;
        this.currentEvent = null;
        this.gameStarted = false;
        this.recentEvents = [];
        this.endingQuestActive = false;
        this.endingQuestStep = 0;
        this.endingQuestResults = [];
        this.score = 0;
        
        this.setupDOMReferences();
        this.initializeGame();
        this.setupEventListeners();
    }

    setupDOMReferences() {
        this.introScreen = document.getElementById('intro-screen');
        this.startButton = document.getElementById('start-button');
        this.eventCard = document.getElementById('event-card');
        this.cardImage = document.getElementById('card-image');
        this.cardTitle = document.getElementById('card-title');
        this.cardDescription = document.getElementById('card-description');
        this.turnCount = document.getElementById('turn-count');
        this.gameStatus = document.getElementById('game-status');
        this.resultCard = document.getElementById('result-card');
        this.resultTitle = document.getElementById('result-title');
        this.resultMessage = document.getElementById('result-message');
        this.resultStats = document.getElementById('result-stats');
        this.confirmButton = document.getElementById('confirm-button');
        this.leaderboardButton = document.getElementById('leaderboard-button');
        this.nameModalOverlay = document.getElementById('name-modal-overlay');
        this.leaderboardModalOverlay = document.getElementById('leaderboard-modal-overlay');
        this.playerNameInput = document.getElementById('player-name-input');
        this.submitScoreButton = document.getElementById('submit-score-button');
        this.closeLeaderboardButton = document.getElementById('close-leaderboard-button');
        this.leaderboardList = document.getElementById('leaderboard-list');
        this.finalScoreDisplay = document.getElementById('final-score-display');
        this.leftHint = document.getElementById('left-hint');
        this.rightHint = document.getElementById('right-hint');
        this.scheduleTrack = document.getElementById('schedule-track');
    }
    
    initializeGame() {
        this.updateStatsDisplay();
        this.initializeScheduleBar();
    }
    
    setupEventListeners() {
        this.startButton.addEventListener('click', () => this.startGame());
        this.leaderboardButton.addEventListener('click', () => this.showLeaderboard());
        this.submitScoreButton.addEventListener('click', () => this.saveScore());
        this.closeLeaderboardButton.addEventListener('click', () => {
            this.leaderboardModalOverlay.style.display = 'none';
            if (this.gameOver) {
                this.restartGame();
            }
        });

        this.eventCard.addEventListener('mousedown', e => this.handleMouseDown(e));
        document.addEventListener('mousemove', e => this.handleMouseMove(e));
        document.addEventListener('mouseup', e => this.handleMouseUp(e));
        this.eventCard.addEventListener('touchstart', e => this.handleTouchStart(e), { passive: false });
        document.addEventListener('touchmove', e => this.handleTouchMove(e), { passive: false });
        document.addEventListener('touchend', e => this.handleTouchEnd(e), { passive: false });
    }

    startGame() {
        this.gameStarted = true;
        this.introScreen.style.display = 'none';
        this.eventCard.style.display = 'block';
        document.getElementById('schedule-bar').style.display = 'block';
        this.loadEvent();
    }

    handleMouseDown(e) { if (this.gameStarted && !this.isDragging) this.startDrag(e.clientX); }
    handleMouseMove(e) { if (this.isDragging) this.updateDrag(e.clientX); }
    handleMouseUp() { if (this.isDragging) this.endDrag(); }
    handleTouchStart(e) { if (this.isDragging) return; if (e.target.closest('#event-card')) e.preventDefault(); this.startDrag(e.touches[0].clientX); }
    handleTouchMove(e) { if (this.isDragging) { e.preventDefault(); this.updateDrag(e.touches[0].clientX); } }
    handleTouchEnd() { if (this.isDragging) this.endDrag(); }

    startDrag(x) {
        this.isDragging = true;
        this.startX = x;
        this.eventCard.style.transition = 'none';
        this.eventCard.style.cursor = 'grab';
    }

    updateDrag(x) {
        this.currentX = x;
        const deltaX = this.currentX - this.startX;
        const rotate = deltaX * 0.1;
        this.eventCard.style.transform = `translateX(${deltaX}px) rotate(${rotate}deg)`;
    }

    endDrag() {
        this.isDragging = false;
        const deltaX = this.currentX - this.startX;
        if (Math.abs(deltaX) > 50) {
            this.makeChoice(deltaX > 0 ? 'right' : 'left');
        } else {
            this.eventCard.style.transition = 'transform 0.3s';
            this.eventCard.style.transform = 'translateX(0) rotate(0deg)';
        }
    }

    makeChoice(choice) {
        if (this.gameOver) return;
        this.eventCard.style.transition = 'transform 0.5s';
        this.eventCard.style.transform = `translateX(${choice === 'left' ? -1000 : 1000}px) rotate(${choice === 'left' ? -30 : 30}deg)`;
        setTimeout(() => this.applyChoice(choice), 200);
    }

    applyChoice(choice) {
        const effects = this.currentEvent.effects[choice];
        for (const stat in effects) {
            this.stats[stat] = Math.max(0, Math.min(100, this.stats[stat] + effects[stat]));
        }
        this.totalWeeks++;
        this.week = (this.totalWeeks - 1) % 52 + 1;
        this.age = 25 + Math.floor((this.totalWeeks - 1) / 52);
        this.updateStatsDisplay();
        this.checkGameOverConditions();
        if (!this.gameOver) {
            this.showResultCard(choice, effects);
        }
    }

    showResultCard(choice, effects) {
        this.eventCard.style.display = 'none';
        this.resultCard.style.display = 'block';
        this.resultTitle.textContent = this.currentEvent.title;
        this.resultMessage.textContent = this.currentEvent.resultMessages ? this.currentEvent.resultMessages[choice] : '';
        this.showResultStats(effects);
        this.confirmButton.onclick = () => this.confirmResult();
    }

    confirmResult() {
        this.resultCard.style.display = 'none';
        this.eventCard.style.transform = 'translateX(0) rotate(0deg)';
        this.eventCard.style.display = 'block';
        this.loadEvent();
    }

    showResultStats(effects) {
        this.resultStats.innerHTML = '';
        for (const [stat, change] of Object.entries(effects)) {
            if (change === 0) continue;
            const statItem = document.createElement('div');
            statItem.className = 'result-stat-item';
            statItem.innerHTML = `<span class="result-stat-icon">${this.getStatIcon(stat)}</span> <span class="result-stat-value ${change > 0 ? 'positive' : 'negative'}">${change > 0 ? '+' : ''}${change}</span> <span>${this.getStatName(stat)}</span>`;
            this.resultStats.appendChild(statItem);
        }
    }

    getStatName(stat) {
        const names = { mental: 'ì •ì‹ ë ¥', finance: 'ì¬ì •', ability: 'ì—­ëŸ‰', confidence: 'ìì‹ ê°', health: 'ì²´ë ¥' };
        return names[stat] || stat;
    }

    getStatIcon(stat) {
        const icons = { mental: 'ğŸ§ ', finance: 'ğŸ’°', ability: 'âš¡', confidence: 'ğŸ’ª', health: 'â¤ï¸' };
        return icons[stat] || 'â“';
    }

    updateStatsDisplay() {
        for (const stat in this.stats) {
            document.getElementById(`${stat}-fill`).style.width = `${this.stats[stat]}%`;
            document.getElementById(`${stat}-value`).textContent = this.stats[stat];
            document.querySelector(`[id="${stat}-bar"]`).closest('.stat-item').classList.toggle('danger', this.stats[stat] <= 20);
        }
        this.turnCount.textContent = `${this.age}ì‚´ (${this.week}ì£¼ì°¨)`;
        this.updateScheduleBar();
    }

    initializeScheduleBar() {
        if (!this.scheduleTrack) return;
        this.scheduleTrack.innerHTML = '';
        for (let week = 1; week <= 52; week++) {
            const marker = document.createElement('div');
            marker.className = 'schedule-marker';
            marker.dataset.week = week;
            marker.style.left = `${((week - 1) / 51) * 100}%`;
            if (week === 22 || week === 44) {
                marker.classList.add('recruitment');
            }
            this.scheduleTrack.appendChild(marker);
        }
        this.updateScheduleBar();
    }

    updateScheduleBar() {
        if (!this.scheduleTrack) return;
        this.scheduleTrack.querySelectorAll('.schedule-marker').forEach(m => m.classList.remove('current'));
        const currentMarker = this.scheduleTrack.querySelector(`[data-week="${this.week}"]`);
        if (currentMarker) currentMarker.classList.add('current');
    }

    checkGameOverConditions() {
        for (const stat in this.stats) {
            if (this.stats[stat] <= 0) {
                this.endGame(false, stat);
                return;
            }
        }
        if (this.stats.ability >= 100 && (this.week === 22 || this.week === 44)) {
             this.endGame(true);
        }
    }

    endGame(isSuccess, reason = '') {
        this.gameOver = true;
        this.eventCard.style.display = 'none';
        this.resultCard.style.display = 'none';
        this.score = this.calculateScore(isSuccess);
        this.showNameModal(this.score);
    }

    calculateScore(isSuccess) {
        const totalStats = Object.values(this.stats).reduce((sum, stat) => sum + stat, 0);
        const successBonus = isSuccess ? 500 : 0;
        return Math.round((totalStats * 2) - (this.totalWeeks * 3) + successBonus);
    }

    showNameModal(score) {
        this.finalScoreDisplay.textContent = score;
        this.nameModalOverlay.style.display = 'flex';
    }

    async saveScore() {
        this.submitScoreButton.disabled = true;
        this.submitScoreButton.textContent = 'ë“±ë¡ ì¤‘...';
        const name = this.playerNameInput.value.trim() || 'ìµëª…ì˜ ë„ì „ì';
        const { error } = await supabaseClient.from('score').insert([{ name, score: this.score }]);
        if (error) {
            console.error('ì ìˆ˜ ì €ì¥ ì‹¤íŒ¨:', error);
            alert('ì ìˆ˜ ë“±ë¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            this.submitScoreButton.disabled = false;
            this.submitScoreButton.textContent = 'ì ìˆ˜ ë“±ë¡';
        } else {
            this.nameModalOverlay.style.display = 'none';
            this.showLeaderboard();
        }
    }

    async showLeaderboard() {
        this.leaderboardModalOverlay.style.display = 'flex';
        this.leaderboardList.innerHTML = '<li>ë¡œë”© ì¤‘...</li>';
        const { data, error } = await supabaseClient.from('score').select('name, score').order('score', { ascending: false }).limit(10);
        if (error) {
            this.leaderboardList.innerHTML = '<li>ë¦¬ë”ë³´ë“œë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.</li>';
        } else {
            this.leaderboardList.innerHTML = '';
            if (data.length === 0) {
                this.leaderboardList.innerHTML = '<li>ì•„ì§ ë“±ë¡ëœ ì ìˆ˜ê°€ ì—†ìŠµë‹ˆë‹¤.</li>';
            } else {
                data.forEach((entry, index) => {
                    const li = document.createElement('li');
                    li.innerHTML = `<span class="rank">${index + 1}ìœ„</span> <span class="name">${entry.name}</span> <span class="score">${entry.score}ì </span>`;
                    this.leaderboardList.appendChild(li);
                });
            }
        }
    }

    restartGame() {
        window.location.reload();
    }
    
    loadEvent() {
        const events = [
            { title: "í¬íŠ¸í´ë¦¬ì˜¤ ì œì‘", description: "ê²Œì„ í¬íŠ¸í´ë¦¬ì˜¤ë¥¼ ë§Œë“¤ê¹Œ ê³ ë¯¼ì´ ë©ë‹ˆë‹¤.\nì–´ë–»ê²Œ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?", image: "images/portfolio.png", prob: 1, choices: { left: "ì œì‘í•œë‹¤.", right: "ë‹¤ìŒ ê¸°íšŒë¡œ ë¯¸ë£¬ë‹¤." }, effects: { left: { ability: 5, mental: -5, finance: -5}, right: { ability: -3, mental: +5 } }, resultMessages: { left: "í¬íŠ¸í´ë¦¬ì˜¤ë¥¼ ì •ì„±ìŠ¤ëŸ½ê²Œ ì œì‘í–ˆìŠµë‹ˆë‹¤.", right: "ë‹¤ìŒ ê¸°íšŒë¡œ ë¯¸ë¤˜ìŠµë‹ˆë‹¤." } },
            { title: "ì˜¨ë¼ì¸ ê°•ì˜", description: "ê²Œì„ ê°œë°œ ì˜¨ë¼ì¸ ê°•ì˜ë¥¼ ë“¤ì„ ê¸°íšŒê°€ ìˆìŠµë‹ˆë‹¤.\nì–´ë–»ê²Œ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?", image: "images/online.png", prob: 2, choices: { left: "ê³ ê¸‰ ê°•ì˜ ìˆ˜ê°•", right: "ë¬´ë£Œ ê°•ì˜ ìˆ˜ê°•" }, effects: { left: { ability: 8, finance: -10, mental: -5 }, right: { ability: 4 } }, resultMessages: { left: "ì—­ëŸ‰ì´ í¬ê²Œ í–¥ìƒë˜ì—ˆìŠµë‹ˆë‹¤.", right: "ì•ˆì •ì ìœ¼ë¡œ ì—­ëŸ‰ì„ í–¥ìƒì‹œì¼°ìŠµë‹ˆë‹¤." } },
            { title: "ê°œì¸ í”„ë¡œì íŠ¸", description: "ê°œì¸ ê²Œì„ í”„ë¡œì íŠ¸ë¥¼ ì‹œì‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\nì–´ë–»ê²Œ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?", image: "images/portfolio.png", prob: 1, choices: { left: "ëŒ€ê·œëª¨ í”„ë¡œì íŠ¸", right: "ê°„ë‹¨í•œ í”„ë¡œì íŠ¸" }, effects: { left: { ability: 8, mental: -10, health: -5 }, right: { ability: 4, mental: -4 } }, resultMessages: { left: "ì—­ëŸ‰ì´ í¬ê²Œ í–¥ìƒë˜ì—ˆìŠµë‹ˆë‹¤.", right: "ì ë‹¹í•œ ì—­ëŸ‰ í–¥ìƒì„ ê²½í—˜í–ˆìŠµë‹ˆë‹¤." } },
            { title: "ì•Œë°” ì œì•ˆ", description: "ìƒí™œë¹„ë¥¼ ë²Œê¸° ìœ„í•œ ì•Œë°” ì œì•ˆì´ ë“¤ì–´ì™”ìŠµë‹ˆë‹¤.\nì–´ë–»ê²Œ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?", image: "images/money.png", prob: 2, choices: { left: "ì•„ë¥´ë°”ì´íŠ¸ë¥¼ í•œë‹¤.", right: "ì•„ë¥´ë°”ì´íŠ¸ë¥¼ í•˜ì§€ ì•ŠëŠ”ë‹¤." }, effects: { left: { finance: 10, mental: -5, ability: -5 }, right: { finance: -5 } }, resultMessages: { left: "ì¬ì •ì´ ê°œì„ ë˜ì—ˆìŠµë‹ˆë‹¤.", right: "ì—­ëŸ‰ í–¥ìƒì— ì§‘ì¤‘í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤." } },
            { title: "ë©´ì ‘ ì—°ìŠµ", description: "ê²Œì„ íšŒì‚¬ ë©´ì ‘ì„ ìœ„í•œ ëª¨ì˜ ë©´ì ‘ì„ ì—°ìŠµí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\nì–´ë–»ê²Œ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?", image: "images/interview.png", prob: 0.5, choices: { left: "ì „ë¬¸ê°€ì™€ ì—°ìŠµ", right: "í˜¼ì ì—°ìŠµ" }, effects: { left: { confidence: 8, mental: -10, ability: 8 }, right: { confidence: 3, ability: 3 } }, resultMessages: { left: "ìì‹ ê°ê³¼ ì—­ëŸ‰ì´ í¬ê²Œ í–¥ìƒë˜ì—ˆìŠµë‹ˆë‹¤.", right: "ê¸°ë³¸ì ì¸ ì—­ëŸ‰ í–¥ìƒì„ ê²½í—˜í–ˆìŠµë‹ˆë‹¤." } },
            { title: "ê²Œì„ ì¼ ì°¸ê°€", description: "ê²Œì„ ì¼ì— ì°¸ê°€í•˜ì—¬ ì‹¤ë ¥ì„ í‚¤ìš¸ ìˆ˜ ìˆìŠµë‹ˆë‹¤.\nì–´ë–»ê²Œ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?", image: "images/portfolio.png", prob: 0.5, choices: { left: "íŒ€ìœ¼ë¡œ ì°¸ê°€", right: "ê°œì¸ìœ¼ë¡œ ì°¸ê°€" }, effects: { left: { ability: 8, mental: -10, confidence: 5 }, right: { ability: 4 } }, resultMessages: { left: "ì—­ëŸ‰ê³¼ ìì‹ ê°ì´ í¬ê²Œ í–¥ìƒë˜ì—ˆìŠµë‹ˆë‹¤.", right: "ì ë‹¹í•œ ì—­ëŸ‰ í–¥ìƒì„ ê²½í—˜í–ˆìŠµë‹ˆë‹¤." } },
            { title: "ìš´ë™ ì‹œê°„", description: "ì²´ë ¥ì„ ê¸°ë¥´ê¸° ìœ„í•œ ìš´ë™ì„ í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\nì–´ë–»ê²Œ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?", image: "images/health.png", prob: 1, choices: { left: "ê²©ë ¬í•œ ìš´ë™", right: "ê°€ë²¼ìš´ ìš´ë™" }, effects: { left: { health: 8, mental: -5 }, right: { health: 4, mental: 2 } }, resultMessages: { left: "ì²´ë ¥ì´ í¬ê²Œ í–¥ìƒë˜ì—ˆìŠµë‹ˆë‹¤.", right: "ì²´ë ¥ê³¼ ì •ì‹ ë ¥ì´ ëª¨ë‘ í–¥ìƒë˜ì—ˆìŠµë‹ˆë‹¤." } },
            { title: "ì¹œêµ¬ì™€ì˜ ë§Œë‚¨", description: "ì¹œêµ¬ë“¤ê³¼ ë§Œë‚˜ì„œ ìŠ¤íŠ¸ë ˆìŠ¤ë¥¼ í•´ì†Œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\nì–´ë–»ê²Œ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?", image: "images/friend_success.png", prob: 1, choices: { left: "ì¹œêµ¬ë“¤ê³¼ ë§Œë‚œë‹¤.", right: "í˜¼ì ì‹œê°„ì„ ë³´ë‚¸ë‹¤." }, effects: { left: { mental: 8, finance: -5 }, right: { mental: 3 } }, resultMessages: { left: "ì •ì‹ ë ¥ì´ í¬ê²Œ íšŒë³µë˜ì—ˆìŠµë‹ˆë‹¤.", right: "ì •ì‹ ë ¥ì´ ì¡°ê¸ˆ íšŒë³µë˜ì—ˆìŠµë‹ˆë‹¤." } },
            { title: "ë©˜í† ë§", description: "ê²Œì„ ì—…ê³„ ì„ ë°°ì™€ ë©˜í† ë§ì„ ë°›ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.\nì–´ë–»ê²Œ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?", image: "images/mentoring.png", prob: 0.5, choices: { left: "ê³ ê¸‰ ë©˜í† ë§", right: "ë¬´ë£Œ ë©˜í† ë§" }, effects: { left: { ability: 8, confidence: 5, finance: -10 }, right: { ability: 4, confidence: 2 } }, resultMessages: { left: "ì—­ëŸ‰ê³¼ ìì‹ ê°ì´ í¬ê²Œ í–¥ìƒë˜ì—ˆìŠµë‹ˆë‹¤.", right: "ê¸°ë³¸ì ì¸ ì—­ëŸ‰ í–¥ìƒì„ ê²½í—˜í–ˆìŠµë‹ˆë‹¤." } },
            { title: "íŒ€ í”„ë¡œì íŠ¸", description: "íŒ€ í”„ë¡œì íŠ¸ì— ì°¸ì—¬í•  ê¸°íšŒê°€ ìˆìŠµë‹ˆë‹¤.\nì–´ë–»ê²Œ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?", image: "images/team_project.png", prob: 1, choices: { left: "íŒ€ì¥ìœ¼ë¡œ ì°¸ì—¬", right: "íŒ€ì›ìœ¼ë¡œ ì°¸ì—¬" }, effects: { left: { ability: 8, confidence: 5, mental: -8 }, right: { ability: 5, mental: -3 } }, resultMessages: { left: "ì—­ëŸ‰ê³¼ ìì‹ ê°ì´ í¬ê²Œ í–¥ìƒë˜ì—ˆìŠµë‹ˆë‹¤.", right: "ì ë‹¹í•œ ì—­ëŸ‰ í–¥ìƒì„ ê²½í—˜í–ˆìŠµë‹ˆë‹¤." } },
            { title: "ì „ê³µ ì„œì  ë…ì„œ", description: "ê²Œì„ ê°œë°œ ê´€ë ¨ ì„œì ì„ ì½ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.\nì–´ë–»ê²Œ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?", image: "images/book.png", prob: 1, choices: { left: "ê³ ê¸‰ ì„œì  ì½ê¸°", right: "ê¸°ì´ˆ ì„œì  ì½ê¸°" }, effects: { left: { ability: 6, mental: -5 }, right: { ability: 3, mental: 2 } }, resultMessages: { left: "ì—­ëŸ‰ì´ í–¥ìƒë˜ì—ˆì§€ë§Œ ì •ì‹ ë ¥ì´ ì†Œëª¨ë˜ì—ˆìŠµë‹ˆë‹¤.", right: "ì—­ëŸ‰ê³¼ ì •ì‹ ë ¥ì´ ëª¨ë‘ í–¥ìƒë˜ì—ˆìŠµë‹ˆë‹¤." } },
            { title: "êµ­ë‚´ ì—¬í–‰", description: "ì§§ì€ ì—¬í–‰ì„ í†µí•´ ìŠ¤íŠ¸ë ˆìŠ¤ë¥¼ í•´ì†Œí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.\nì–´ë–»ê²Œ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?", image: "images/korea.png", prob: 0.5, choices: { left: "ì—¬í–‰ì„ ê°„ë‹¤.", right: "ì§‘ì— ë¨¸ë¬¸ë‹¤." }, effects: { left: { mental: 8, health: 5, finance: -8 }, right: { mental: 3 } }, resultMessages: { left: "ì •ì‹ ë ¥ê³¼ ì²´ë ¥ì´ í¬ê²Œ íšŒë³µë˜ì—ˆìŠµë‹ˆë‹¤.", right: "ì •ì‹ ë ¥ì´ ì¡°ê¸ˆ íšŒë³µë˜ì—ˆìŠµë‹ˆë‹¤." } }
        ];
        
        let availableEvents = events.filter(event => !this.recentEvents.includes(event.title));
        if (availableEvents.length === 0) { this.recentEvents = []; availableEvents = events; }
        this.currentEvent = this.selectEventByProbability(availableEvents);
        this.recentEvents.push(this.currentEvent.title);
        if (this.recentEvents.length > 3) this.recentEvents.shift();

        this.cardImage.src = this.currentEvent.image;
        this.cardTitle.textContent = this.currentEvent.title;
        this.cardDescription.textContent = this.currentEvent.description;
    }

    selectEventByProbability(events) {
        const weights = [];
        let totalWeight = 0;
        for (const event of events) { totalWeight += event.prob || 1; weights.push(totalWeight); }
        const random = Math.random() * totalWeight;
        for (let i = 0; i < weights.length; i++) { if (random < weights[i]) return events[i]; }
        return events[events.length - 1];
    }
}

document.addEventListener('DOMContentLoaded', () => {
    new ReignsGame();
});